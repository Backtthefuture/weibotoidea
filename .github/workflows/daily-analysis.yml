name: å¾®åšçƒ­æœæ¯æ—¥åˆ†æ

on:
  # å®šæ—¶ä»»åŠ¡ - æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9:00ã€ä¸‹åˆ4:00å’Œæ™šä¸Š9:00ï¼ˆUTCæ—¶é—´1:00ã€8:00å’Œ13:00ï¼‰
  schedule:
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00
    - cron: '0 8 * * *'   # åŒ—äº¬æ—¶é—´ 16:00
    - cron: '0 13 * * *'  # åŒ—äº¬æ—¶é—´ 21:00

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºåç»­æ“ä½œ

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # è‡ªåŠ¨ç¼“å­˜ pip ä¾èµ–

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: |
        mkdir -p analysis_results/archive

    - name: è¿è¡Œå¾®åšçƒ­æœåˆ†æ
      env:
        TIANXING_API_KEY: ${{ secrets.TIANXING_API_KEY }}
        ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      run: |
        echo "å¼€å§‹æ‰§è¡Œå¾®åšçƒ­æœåˆ†æ..."
        python3 run_weibo_agent.py

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        ls -lah *.html 2>/dev/null || echo "æ ¹ç›®å½•æœªæ‰¾åˆ° HTML æ–‡ä»¶"
        ls -lah analysis_results/ 2>/dev/null || echo "analysis_results ç›®å½•ä¸ºç©º"

    - name: å¤åˆ¶ HTML æŠ¥å‘Šåˆ°è¾“å‡ºç›®å½•
      run: |
        # è·å–å½“å‰æ—¥æœŸ
        DATE=$(date +%Y-%m-%d)

        # æŸ¥æ‰¾å¹¶å¤åˆ¶æ‰€æœ‰ç”Ÿæˆçš„ HTML æ–‡ä»¶
        if [ -f "å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææŠ¥å‘Š.html" ]; then
          cp "å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææŠ¥å‘Š.html" "analysis_results/index.html"
          cp "å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææŠ¥å‘Š.html" "analysis_results/archive/${DATE}.html"
          echo "âœ… å·²å¤åˆ¶æŠ¥å‘Šåˆ° analysis_results/"
        else
          echo "âš ï¸ æœªæ‰¾åˆ° HTML æŠ¥å‘Šæ–‡ä»¶"
        fi

        # ç”Ÿæˆå†å²æŠ¥å‘Šç´¢å¼•
        cd analysis_results/archive
        echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>å¾®åšçƒ­æœåˆ†æ - å†å²æŠ¥å‘Š</title></head><body>' > index.html
        echo '<h1>å¾®åšçƒ­æœåˆ†æ - å†å²æŠ¥å‘Š</h1><ul>' >> index.html
        for file in *.html; do
          if [ "$file" != "index.html" ]; then
            echo "<li><a href=\"$file\">$file</a></li>" >> index.html
          fi
        done
        echo '</ul></body></html>' >> index.html

    - name: éƒ¨ç½²åˆ° GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./analysis_results
        publish_branch: gh-pages
        keep_files: false  # æ¯æ¬¡æ¸…ç©ºåé‡æ–°éƒ¨ç½²ï¼Œé¿å…ç´¯ç§¯è¿‡å¤šå†å²æ–‡ä»¶
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ğŸ¤– è‡ªåŠ¨æ›´æ–°å¾®åšçƒ­æœåˆ†ææŠ¥å‘Š'

    - name: æŠ¥å‘ŠçŠ¶æ€
      if: always()
      run: |
        if [ -f "analysis_results/index.html" ]; then
          echo "âœ… åˆ†æå®Œæˆï¼æŠ¥å‘Šå·²ç”Ÿæˆå¹¶éƒ¨ç½²"
          echo "ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        else
          echo "âŒ åˆ†æå¤±è´¥æˆ–æœªç”ŸæˆæŠ¥å‘Š"
          exit 1
        fi
