name: å¾®åšçƒ­æœæ¯æ—¥åˆ†æ

on:
  # å®šæ—¶ä»»åŠ¡ - æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9:00ã€ä¸‹åˆ4:00å’Œæ™šä¸Š9:00ï¼ˆUTCæ—¶é—´1:00ã€8:00å’Œ13:00ï¼‰
  schedule:
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00
    - cron: '0 8 * * *'   # åŒ—äº¬æ—¶é—´ 16:00
    - cron: '0 13 * * *'  # åŒ—äº¬æ—¶é—´ 21:00

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºåç»­æ“ä½œ

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # è‡ªåŠ¨ç¼“å­˜ pip ä¾èµ–

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: |
        mkdir -p analysis_results/archive

    - name: è¿è¡Œå¾®åšçƒ­æœåˆ†æ
      env:
        TIANXING_API_KEY: ${{ secrets.TIANXING_API_KEY }}
        ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      run: |
        echo "å¼€å§‹æ‰§è¡Œå¾®åšçƒ­æœåˆ†æ..."
        python3 run_weibo_agent.py

    - name: åˆå¹¶åˆ†æç»“æœå¹¶ç”Ÿæˆ HTML æŠ¥å‘Š
      run: |
        echo "æ­¥éª¤1: åˆå¹¶åˆ†æç»“æœ..."
        python3 combine_results.py

        echo "æ­¥éª¤2: ç”Ÿæˆ HTML æŠ¥å‘Š..."
        python3 generate_apple_style_report.py

        echo "æ­¥éª¤3: ç”Ÿæˆæ™ºèƒ½é¦–é¡µå’Œå½’æ¡£ç´¢å¼•..."
        python3 generate_index_pages.py

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        echo "=== æŠ¥å‘Šæ–‡ä»¶ ==="
        ls -lh analysis_results/*.html 2>/dev/null || echo "æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶"
        echo "=== å½’æ¡£æ–‡ä»¶ ==="
        ls -lh analysis_results/archive/*.html 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°å½’æ¡£æ–‡ä»¶"

    - name: éƒ¨ç½²åˆ° GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./analysis_results
        publish_branch: gh-pages
        keep_files: true  # ä¿ç•™å†å²æ–‡ä»¶ï¼Œç´¯ç§¯å½’æ¡£
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ğŸ¤– è‡ªåŠ¨æ›´æ–°å¾®åšçƒ­æœåˆ†ææŠ¥å‘Š'

    - name: æŠ¥å‘ŠçŠ¶æ€
      if: always()
      run: |
        if [ -f "analysis_results/index.html" ]; then
          echo "âœ… åˆ†æå®Œæˆï¼æŠ¥å‘Šå·²ç”Ÿæˆå¹¶éƒ¨ç½²"
          echo "ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        else
          echo "âŒ åˆ†æå¤±è´¥æˆ–æœªç”ŸæˆæŠ¥å‘Š"
          exit 1
        fi
